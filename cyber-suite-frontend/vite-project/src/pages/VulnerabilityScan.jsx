// src/pages/VulnerabilityScan.jsx
import { useState, useEffect, useRef } from "react";
import { ShieldCheckIcon, MagnifyingGlassIcon } from "@heroicons/react/24/outline";
import CyberGridBackground from "../components/CyberGridBackground";

export default function VulnerabilityScan() {
  const [loading, setLoading] = useState(false);
  const [scanData, setScanData] = useState(null);
  const [url, setUrl] = useState("");
  const [expandedCVE, setExpandedCVE] = useState({});
  const [cveIntelLoading, setCveIntelLoading] = useState(false);
  const [activeTab, setActiveTab] = useState('free'); // 'free', 'ssl', 'premium'
  const cveIntelRef = useRef(false); // Prevent multiple simultaneous calls
  const timerRef = useRef(null);
  // Animated placeholder for input
  const placeholderVariants = [
    "https://example.com",
    "https://yourdomain.com",
    "https://mysite.org",
    "https://secure-site.net"
  ];
  const [phIdx, setPhIdx] = useState(0);
  const [phText, setPhText] = useState("");
  useEffect(() => {
    let charIdx = 0;
    let typing;
    function typeNext() {
      setPhText(placeholderVariants[phIdx].slice(0, charIdx));
      charIdx++;
      if (charIdx > placeholderVariants[phIdx].length) {
        clearInterval(typing);
        setTimeout(() => {
          setPhIdx((prev) => (prev + 1) % placeholderVariants.length);
        }, 1200);
      }
    }
    typing = setInterval(typeNext, 90);
    return () => clearInterval(typing);
  }, [phIdx]);
  // Auto-scan when URL changes (debounced)
  useEffect(() => {
    if (timerRef.current) clearTimeout(timerRef.current);
    if (!url || !/^https?:\/\/.+\..+/.test(url)) {
      setScanData(null);
      setLoading(false);
      return;
    }
    timerRef.current = setTimeout(() => {
      runScan();
    }, 500);
    return () => {
      if (timerRef.current) clearTimeout(timerRef.current);
    };
  }, [url]);

  const runScan = async () => {
  if (!url) return;
    setLoading(true);
    setScanData(null);

    try {
      const API_BASE = import.meta.env.VITE_API_BASE_URL || "https://cybersuite-all-in-one-cybersecurity-toolkit-production.up.railway.app";
      const res = await fetch(`${API_BASE}/api/vuln/lite`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url }),
        credentials: 'include'
      });
      const data = await res.json();
      console.log("üîç Scan Data Received:", data);
      setScanData(data);
    } catch (err) {
      console.error("‚ùå Scan Error:", err);
      alert("Scan failed. Please check the backend.");
    } finally {
      setLoading(false);
    }
  };

  const handleRunCveIntel = async (software) => {
    // Prevent multiple simultaneous calls
    if (!software || cveIntelRef.current || cveIntelLoading) return;
    
    cveIntelRef.current = true;
    setCveIntelLoading(true);
    
    // Scroll to CVE section
    setTimeout(() => {
      const cveSection = document.querySelector('[data-cve-section]');
      if (cveSection) {
        cveSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }, 100);
    
    try {
      const API_BASE = import.meta.env.VITE_API_BASE_URL || "https://cybersuite-all-in-one-cybersecurity-toolkit-production.up.railway.app";
      console.log("üì° Fetching CVE Intel for:", software);
      const res = await fetch(`${API_BASE}/api/cve/intel`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ software }),
        credentials: 'include'
      });
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      
      const intel = await res.json();
      console.log("‚úÖ CVE Intel Received:", intel);
      
      setScanData(prev => {
        if (!prev) return prev;
        return {
          ...prev,
          cveIntel: intel || { items: [] }
        };
      });
    } catch (err) {
      console.error("‚ùå CVE Intel Error:", err);
      setScanData(prev => {
        if (!prev) return prev;
        return {
          ...prev,
          cveIntel: { items: [], note: "CVE threat intelligence fetch failed. Please try again." }
        };
      });
    } finally {
      cveIntelRef.current = false;
      setCveIntelLoading(false);
    }
  };

  const getSeverityColor = (severity) => {
    switch (severity?.toLowerCase()) {
      case "low":
        return "bg-green-100 text-green-800";
      case "medium":
        return "bg-yellow-100 text-yellow-800";
      case "high":
      case "critical":
        return "bg-red-100 text-red-800";
      default:
        return "bg-gray-100 text-gray-800";
    }
  };

  const getHeaderStatusDisplay = (headerData) => {
    if (!headerData) return { text: 'Not detected', className: 'text-gray-600 font-semibold' };
    
    const { status, detected_value } = headerData;
    
    switch (status) {
      case 'present_secure':
        return { text: 'Present (Secure)', className: 'text-green-600 font-semibold' };
      case 'present_weak':
        return { text: 'Present (Weak)', className: 'text-yellow-600 font-semibold' };
      case 'deprecated':
        return { text: 'Deprecated', className: 'text-red-600 font-semibold' };
      case 'not_detected':
        return { text: 'Not detected', className: 'text-gray-600 font-semibold' };
      default:
        return { text: 'Not detected', className: 'text-gray-600 font-semibold' };
    }
  };
  
  const formatTlsVersionLabel = (v) => {
    if (!v) return '';
    if (v === 'TLSv1_3' || v === 'TLSv13') return 'TLS 1.3';
    if (v === 'TLSv1_2' || v === 'TLSv12') return 'TLS 1.2';
    if (v === 'TLSv1_1' || v === 'TLSv11') return 'TLS 1.1';
    if (v === 'TLSv1' || v === 'TLSv10') return 'TLS 1.0';
    return v;
  };

  const calculateRisk = () => {
    if (!scanData?.findings)
      return { level: "Unknown", color: "bg-gray-500" };
    // Treat popular domains as low risk
    const popularSafeDomains = [
      "openai.com",
      "youtube.com",
      "google.com",
      "github.com",
      "facebook.com",
      "twitter.com"
    ];
    try {
      const urlObj = new URL(url);
      const domain = urlObj.hostname.replace(/^www\./, "");
      if (popularSafeDomains.some(d => domain.endsWith(d))) {
        return { level: "Low Risk", color: "bg-green-600" };
      }
    } catch {}
    const findingsCount = scanData.findings.length;
    // Risk thresholds: >= 6 = red (High), > 2 = orange (Medium), else green (Low)
    if (findingsCount >= 6) return { level: "High Risk", color: "bg-red-600" };
    if (findingsCount > 2) return { level: "Medium Risk", color: "bg-amber-500" };
    return { level: "Low Risk", color: "bg-green-600" };
  };

  const downloadPDF = () => {
    if (!scanData) return alert("No scan data to generate report.");
    const API_BASE = import.meta.env.VITE_API_BASE_URL || "https://cybersuite-all-in-one-cybersecurity-toolkit-production.up.railway.app";
    fetch(`${API_BASE}/api/report/generate`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(scanData),
      credentials: 'include'
    })
      .then((res) => {
        if (!res.ok) throw new Error("PDF generation failed");
        return res.blob();
      })
      .then((blob) => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "cybersuite-report.pdf";
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
      })
      .catch((err) => {
        alert("PDF download failed: " + err.message);
      });
  };

  // Scan dashboard animation state
  const [scanStep, setScanStep] = useState(0);
  const scanSteps = [
    { label: "SSL Check" },
    { label: "Security Headers" },
    { label: "Malware Blacklists" },
    { label: "Open Ports" },
    { label: "Known CVEs" }
  ];
  useEffect(() => {
    if (loading) {
      setScanStep(0);
      let step = 0;
      const interval = setInterval(() => {
        step++;
        setScanStep(step);
        if (step >= scanSteps.length) clearInterval(interval);
      }, 900); // 4.5s total
      return () => clearInterval(interval);
    }
  }, [loading]);

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-slate-900 to-gray-950 p-4 sm:p-6 relative overflow-hidden">
      {!scanData && <CyberGridBackground />}
      <div>
        {/* Big Title with Icon */}
        <div className={`flex flex-col items-center mb-8 transition-all duration-700 ${loading ? 'scale-95 opacity-80' : ''}`}>
            <div className="flex flex-col sm:flex-row items-center gap-3 mb-2 text-center sm:text-left">
            <div className="flex items-center gap-2">
              <span className="inline-block"><ShieldCheckIcon className="w-8 sm:w-10 h-8 sm:h-10 text-cyan-400" /></span>
              <span className="inline-block"><MagnifyingGlassIcon className="w-6 sm:w-8 h-6 sm:h-8 text-cyan-300" /></span>
            </div>
              <h1 className="text-2xl sm:text-4xl font-extrabold text-cyan-200 tracking-tight drop-shadow-lg">Security Observations</h1>
          </div>
          <div className="text-sm sm:text-base text-cyan-400 font-medium mb-2 text-center sm:text-left">Scan your site for security findings, misconfigurations, and known threats in real time.</div>
        </div>

        {/* Input Form with animated placeholder */}
        {!loading && !scanData && (
          <div className="bg-slate-900 shadow-xl rounded-xl p-6 mb-8 border border-cyan-700">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
              <input
                type="text"
                placeholder={phText || placeholderVariants[phIdx]}
                className="border border-cyan-700 rounded px-3 py-2 w-full col-span-2 font-mono text-lg bg-gray-950 text-cyan-200 focus:ring-2 focus:ring-cyan-400"
                value={url}
                onChange={(e) => setUrl(e.target.value)}
                onKeyDown={e => {
                  if (e.key === 'Enter') {
                    runScan();
                  }
                }}
                style={{ transition: 'box-shadow 0.3s', boxShadow: loading ? '0 0 8px #22d3ee' : undefined }}
              />
              <button
                onClick={runScan}
                disabled={loading}
                className="bg-cyan-700 text-white px-4 py-2 rounded hover:bg-cyan-800 disabled:opacity-50 font-bold text-lg transition-all duration-300"
                style={{ boxShadow: loading ? '0 0 8px #22d3ee' : undefined }}
              >
                {loading ? "Scanning..." : "Run Scan"}
              </button>
            </div>
          </div>
        )}

        {/* Dynamic Status Bar & Scan Dashboard */}
        {loading && !scanData && (
          <div className="w-full max-w-2xl mx-auto mb-10">
            {/* Status Bar */}
            <div className="relative h-12 flex items-center justify-center mb-6">
              <div className="absolute left-0 top-0 w-full h-2 bg-gradient-to-r from-cyan-700 via-cyan-400 to-cyan-700 rounded-full overflow-hidden">
                <div className="absolute top-0 left-0 h-2 w-1/6 bg-cyan-300 rounded-full animate-scanbar" style={{ left: `${(scanStep/scanSteps.length)*100}%`, transition: 'left 0.7s cubic-bezier(.4,2,.3,1)' }}></div>
              </div>
              <div className="absolute left-0 top-0 w-full h-12 pointer-events-none overflow-hidden">
                <div className="absolute left-0 top-0 w-full h-full text-xs font-mono text-cyan-900 opacity-30 animate-codeflow" style={{whiteSpace:'pre'}}>
                  {`Checking SSL certificate...\nChecking security headers...\nChecking DNS records...\nChecking for malware...\nChecking CMS version...\nChecking CVEs...`}
                </div>
              </div>
              <div className="absolute" style={{ left: `${(scanStep/scanSteps.length)*100}%`, top: 0, transition: 'left 0.7s cubic-bezier(.4,2,.3,1)' }}>
                <span className="inline-block bg-cyan-700 rounded-full p-2 shadow-lg"><ShieldCheckIcon className="w-7 h-7 text-white" /></span>
              </div>
            </div>
            {/* Scan Cards */}
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 sm:gap-6 mt-2">
              {scanSteps.map((step, idx) => (
                <div key={step.label} className={`rounded-xl p-4 sm:p-6 flex flex-col items-center justify-center bg-gray-950 border-2 ${scanStep > idx ? 'border-green-500' : scanStep === idx ? 'border-yellow-400 animate-pulse' : 'border-cyan-800'} shadow-xl transition-all duration-700`} style={{ minHeight: 100 }}>
                  <div className="font-bold text-cyan-200 text-base sm:text-lg mb-1 text-center">{step.label}</div>
                  <div className={`text-sm font-mono ${scanStep > idx ? 'text-green-400' : scanStep === idx ? 'text-yellow-300' : 'text-cyan-700'}`}>
                    {scanStep > idx ? 'Pass' : scanStep === idx ? 'Scanning...' : 'Pending'}
                  </div>
                </div>
              ))}
            </div>
            {/* Animations */}
            <style>{`
              @keyframes scanbar { 0%{left:0;} 100%{left:85%;} }
              .animate-scanbar { animation: scanbar 4.5s cubic-bezier(.4,2,.3,1) forwards; }
              @keyframes codeflow { 0%{transform:translateY(0);} 100%{transform:translateY(-40%);} }
              .animate-codeflow { animation: codeflow 4.5s linear forwards; }
            `}</style>
          </div>
        )}



        {/* Results Rendering */}
        {scanData && (
          <div>
            {/* Check for unreachable host */}
            {!scanData.ok && scanData.error === 'UNREACHABLE_HOST' ? (
              <div>
                <div className="mb-2 text-lg font-semibold text-cyan-400 animate-fadein">Scanned URL: <span className="font-mono text-cyan-300">{url}</span></div>
                <div className="bg-red-900 border-2 border-red-600 rounded-lg p-8 text-center animate-fadein shadow-lg">
                  
                  <h2 className="text-2xl font-bold text-white mb-2">Website Unreachable</h2>
                  <p className="text-red-100 mb-4">We could not establish a network connection to this domain.</p>
                  <div className="text-left bg-red-800 rounded p-4 text-red-50 text-sm space-y-2">
                    <p><strong>Possible reasons:</strong></p>
                    <ul className="list-disc pl-6 space-y-1">
                      <li>Domain does not exist</li>
                      <li>DNS misconfiguration</li>
                      <li>Website is offline</li>
                      <li>Network connection blocked</li>
                    </ul>
                  </div>
                  <p className="text-red-100 mt-4"><strong>No security analysis could be performed.</strong></p>
                </div>
              </div>
            ) : (
              <>
                <div className="mb-2 text-lg font-semibold text-cyan-400 animate-fadein">Scanned URL: <span className="font-mono text-cyan-300">{url}</span></div>
                
                {/* Limited Scan Banner */}
                {scanData.scan_status === 'limited' && (
                  <div className="mb-4 bg-yellow-900 border-2 border-yellow-600 rounded-lg p-4 text-yellow-100 animate-fadein">
                    <p className="font-semibold mb-1">‚ö†Ô∏è Limited Scan</p>
                    <p className="text-sm">{scanData.scan_limit_reason || 'This website uses advanced security protections that restrict automated analysis.The remote server forcefully closed the connection.'}</p>
                  </div>
                )}
                
                <div className="space-y-6">
              {/* Risk Summary */}
              <div className={`p-4 rounded text-white animate-fadein shadow-lg result-glow ${calculateRisk().level === 'High Risk' ? 'bg-red-600' : calculateRisk().level === 'Low Risk' ? 'bg-green-600' : 'bg-orange-500'}`}> 
                <h2 className="text-lg font-semibold">Overall Risk: {calculateRisk().level}</h2>
                <p>
                  We detected {scanData.findings?.length || 0} security observations across SSL certificates, HTTP headers, open ports, and known CVEs.
                </p>
              </div>

              {/* Tabs Navigation - REMOVED as per request */}
              {/* <div className="bg-gray-800 rounded-lg p-1 mb-6">
                <div className="flex space-x-1">
                  <button
                    onClick={() => setActiveTab('free')}
                    className={`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors ${
                      activeTab === 'free'
                        ? 'bg-blue-600 text-white'
                        : 'text-gray-300 hover:text-white hover:bg-gray-700'
                    }`}
                  >
                    Security Recommendation
                  </button>
                </div>
              </div> */}



              {/* Free Security Recommendations Tab Content */}
              {activeTab === 'free' && (
               <>
                 {/* TLS Configuration */}
                 {scanData.tls && (
                   <div className="bg-gradient-to-r from-indigo-400 via-indigo-300 to-indigo-500 shadow-xl rounded-lg p-6 animate-fadein text-white result-glow mb-6">
                     <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2">
                       <h2 className="text-lg sm:text-xl font-bold text-indigo-700">TLS Configuration</h2>
                       <a href="https://www.cloudflare.com/learning/ssl/what-is-tls/" target="_blank" rel="noopener noreferrer" className="text-base sm:text-lg text-indigo-600 underline font-bold">Learn more about TLS</a>
                     </div>
                     
                     {/* TLS Versions */}
                     {scanData.tls.tls_versions && (
                       <div className="mb-4">
                         <h3 className="font-semibold mb-2">TLS Protocol Versions:</h3>
                          {Object.entries(scanData.tls.tls_versions).map(([version, status]) => {
                           const isSecure = status === 'enabled' && (version === 'TLSv1_2' || version === 'TLSv1_3' || version === 'TLSv12' || version === 'TLSv13');
                           const isDeprecated = status === 'enabled' && (version === 'TLSv1' || version === 'TLSv1_1' || version === 'TLSv10' || version === 'TLSv11');
                           return (
                             <p key={version}>
                               <strong>{version}:</strong> 
                               <span className={status === 'enabled' ? (isSecure ? 'text-green-600 font-semibold' : isDeprecated ? 'text-red-600 font-semibold' : 'text-yellow-600 font-semibold') : 'text-gray-600 font-semibold'} style={{marginLeft:'6px'}}>
                                 {formatTlsVersionLabel(version)} ‚Äî {status === 'enabled' ? 'Enabled' : 'Disabled'}
                               </span>
                             </p>
                           );
                         })}
                       </div>
                     )}
                   </div>
                 )}
                 
                 {/* HTTP Security Headers */}
                  {scanData.site?.headers_classified && (
                    <div className="bg-gradient-to-r from-blue-400 via-blue-300 to-blue-500 shadow-xl rounded-lg p-6 animate-fadein text-white result-glow">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-xl font-bold text-indigo-700">HTTP Security Headers</h2>
                    <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers" target="_blank" rel="noopener noreferrer" className="text-lg text-indigo-600 underline font-bold" style={{alignSelf:'center', marginLeft:'auto', marginRight:'auto'}}>Learn more about HTTP Security Headers</a>
                  </div>
                  {scanData.scan_status === 'limited' ? (
                    <div className="bg-yellow-100 text-yellow-800 rounded p-3">
                      <p className="text-sm"> Headers could not be fully analyzed due to active security protections. The remote servers forcefully closed the connection</p>
                    </div>
                  ) : (
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* Left Panel - Header List */}
                      <div>
                        <h3 className="font-semibold mb-3 text-indigo-700">Header Status</h3>
                        {scanData.site?.headers_classified && Object.entries(scanData.site.headers_classified)
                          .filter(([headerName]) => !headerName.match(/x[-_]?xss[-_]?protection/i))
                          .map(([headerName, headerData]) => {
                          const display = getHeaderStatusDisplay(headerData);
                          return (
                            <div key={headerName} className="mb-3 p-3 bg-white bg-opacity-50 rounded border">
                              <div className="flex justify-between items-center">
                                <strong className="text-sm text-blue-700">{headerName.replace(/([A-Z])/g, '-$1').replace(/^-/, '')}</strong>
                                <span className={display.className}>{display.text}</span>
                              </div>
                              {headerData.detected_value && (
                                <div className="text-xs text-gray-600 mt-1 truncate">
                                  {headerData.detected_value}
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                      
                      {/* Right Panel - Details */}
                      <div>
                        <h3 className="font-semibold mb-3 text-indigo-700">Header Details</h3>
                        <div className="space-y-4">
                          {scanData.site?.headers_classified && Object.entries(scanData.site.headers_classified)
                            .filter(([headerName]) => !headerName.match(/x[-_]?xss[-_]?protection/i))
                            .map(([headerName, headerData]) => {
                            const display = getHeaderStatusDisplay(headerData);
                            return (
                              <div key={`${headerName}-details`} className="p-3 bg-white bg-opacity-50 rounded border">
                                <h4 className="font-semibold text-sm mb-2 text-blue-700">{headerName.replace(/([A-Z])/g, '-$1').replace(/^-/, '')}</h4>
                                {headerData.detected_value && (
                                  <div className="mb-2">
                                    <span className="text-xs font-semibold text-gray-700">Detected Value:</span>
                                    <div className="text-xs text-gray-600 bg-gray-100 p-2 rounded mt-1 font-mono break-all">
                                      {headerData.detected_value}
                                    </div>
                                  </div>
                                )}
                                <div className="mb-2">
                                  <span className="text-xs font-semibold text-gray-700">Explanation:</span>
                                  <p className="text-xs text-gray-600 mt-1">{headerData.explanation}</p>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              )}

                </>
              )}

              {/* Reputation Check */}
              {scanData.site?.reputation && (
                <div className="bg-gradient-to-r from-purple-400 via-purple-300 to-purple-500 shadow-xl rounded-lg p-6 animate-fadein text-white result-glow">
                  <h2 className="text-xl font-bold mb-4 text-indigo-700">Google Safe Browsing</h2>
                  <p>
                    Safe Browsing Report:{" "}
                    {(scanData.site.reputation.matches && scanData.site.reputation.matches.length > 0) ? (
                      <span className="text-red-600 font-semibold">‚ö†Ô∏è Malicious activity detected!</span>
                    ) : (
                      <span className="text-green-600 font-semibold">No known threats</span>
                    )}
                  </p>
                  {(scanData.site.reputation.matches && scanData.site.reputation.matches.length > 0) && (
                    <ul className="list-disc pl-6 mt-2 text-sm text-red-700">
                      {scanData.site.reputation.matches.map((match, i) => (
                        <li key={i}>{match.threatType}</li>
                      ))}
                    </ul>
                  )}
                  <p className="text-sm text-gray-600 mt-2 italic">
                    Google's Safe Browsing API checks if the domain is flagged for malware, phishing, or social engineering.
                  </p>
                </div>
              )}

              {/* CVEs / Security Findings */}
              <div className="bg-gradient-to-r from-teal-400 via-cyan-300 to-blue-400 shadow-xl rounded-lg p-6 animate-fadein text-white result-glow" data-cve-section>
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-xl font-bold text-indigo-700">Security Findings ‚Äî Known CVEs</h2>
                  <a href="https://www.cve.org/About/Overview" target="_blank" rel="noopener noreferrer" className="text-lg text-indigo-600 underline font-bold">Learn more about CVEs</a>
                </div>
                
                {(() => {
                  const cveFindings = (scanData.findings || []).filter((f) => f.category === 'cve');
                  const cveStatus = scanData.cves?.status;
                  const detectedSoftware = scanData.cves?.software;
                  const detectedVersion = scanData.cves?.version;
                  
                  // CASE 1: Version detected - show confirmed CVEs
                  if (cveStatus === 'confirmed' && cveFindings.length > 0) {
                    return (
                      <div>
                        <div className="flex items-center gap-2 mb-3">
                          <h3 className="font-semibold text-lg text-indigo-700">Confirmed CVEs for {detectedSoftware} {detectedVersion}</h3>
                          <div className="flex items-center gap-1 px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium confidence-badge">
                            <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                              <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                            </svg>
                            <span>Confirmed</span>
                          </div>
                        </div>
                        <ul className="space-y-3">
                          {cveFindings.map((cve, idx) => {
                            const cveUrl = cve.id ? `https://nvd.nist.gov/vuln/detail/${cve.id}` : null;
                            return (
                              <li key={idx} className="border border-gray-300 rounded-lg p-4 bg-white/10 hover:bg-white/20 hover:shadow-md transition-all duration-300 transform hover:scale-[1.01] group cve-card confirmed-cve">
                                <div className="flex items-start justify-between gap-3 mb-2">
                                  <div className="flex-1">
                                    <div className="flex items-center gap-2">
                                      <a href={cveUrl} target="_blank" rel="noopener noreferrer" className="font-semibold text-indigo-600 underline hover:text-indigo-700 transition-colors">
                                        {cve.id}
                                      </a>
                                      {cve.likely_applicable && (
                                        <span className="px-2 py-0.5 bg-blue-100 text-blue-800 rounded-full text-xs font-medium animate-bounce">
                                          Likely Applicable
                                        </span>
                                      )}
                                    </div>
                                  </div>
                                  <span className={`px-2 py-1 rounded text-xs whitespace-nowrap ${getSeverityColor(cve.severity)}`}>
                                    {cve.severity}
                                  </span>
                                </div>
                                <p className="text-sm text-gray-900 mb-2">{cve.detail || 'No details available'}</p>
                                {cve.detection_basis && (
                                  <div className="mt-2 p-2 bg-blue-50 rounded border-l-4 border-blue-400">
                                    <p className="text-xs text-blue-800">
                                      <strong>Detection Basis:</strong> {cve.detection_basis}
                                    </p>
                                  </div>
                                )}
                              </li>
                            );
                          })}
                        </ul>
                      </div>
                    );
                  }
                  
                  // CASE 2: Intel results - show with warning (render before 'skipped')
                  if (scanData?.cveIntel && scanData.cveIntel.items && scanData.cveIntel.items.length > 0) {
                    return (
                      <div>
                        <div className="mb-4 p-3 rounded-lg bg-gradient-to-r from-yellow-50 to-orange-50 border-l-4 border-yellow-400 shadow-sm max-w-2xl">
                          <div className="flex items-center gap-3">
                            <div className="flex-shrink-0">
                              <svg className="w-4 h-4 text-yellow-600 threat-indicator" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                              </svg>
                            </div>
                            <div className="flex items-center gap-2">
                              <span className="font-medium text-yellow-800">Threat Intel</span>
                              <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${
                                scanData.cveIntel.items.some(cve => cve.confidence === 'high') ? 'bg-red-200 text-red-900' :
                                scanData.cveIntel.items.some(cve => cve.confidence === 'medium') ? 'bg-orange-200 text-orange-900' :
                                'bg-yellow-200 text-yellow-900'
                              }`}>
                                {scanData.cveIntel.items.some(cve => cve.confidence === 'high') ? 'High Risk' :
                                 scanData.cveIntel.items.some(cve => cve.confidence === 'medium') ? 'Medium Risk' :
                                 'Low Risk'}
                              </span>
                              <span className="text-yellow-700 text-xs">Inferred from technology detection</span>
                            </div>
                          </div>
                        </div>
                        <ul className="space-y-3">
                          {scanData.cveIntel.items.slice(0, 10).map((cve, idx) => {
                            const cveUrl = cve.id ? `https://nvd.nist.gov/vuln/detail/${cve.id}` : null;
                            return (
                              <li key={idx} className="border border-gray-300 rounded-lg p-4 bg-white/10 hover:bg-white/20 hover:shadow-md transition-all duration-300 transform hover:scale-[1.01] group cve-card intel-cve relative overflow-hidden">
                                <div className="absolute top-0 right-0 w-2 h-full bg-gradient-to-b from-yellow-400 to-orange-400 opacity-20"></div>
                                <div className="flex items-start justify-between gap-3 mb-2">
                                  <div className="flex-1">
                                    <div className="flex items-center gap-2">
                                      <a href={cveUrl} target="_blank" rel="noopener noreferrer" className="font-semibold text-indigo-600 underline hover:text-indigo-700 transition-colors">
                                        {cve.id}
                                      </a>
                                      <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${
                                        cve.confidence === 'high' ? 'bg-red-100 text-red-800' :
                                        cve.confidence === 'medium' ? 'bg-orange-100 text-orange-800' :
                                        'bg-yellow-100 text-yellow-800'
                                      } threat-indicator`}>
                                        {cve.confidence === 'high' ? 'High Confidence' :
                                         cve.confidence === 'medium' ? 'Medium Confidence' :
                                         'Low Confidence'}
                                      </span>
                                    </div>
                                  </div>
                                  <span className={`px-2 py-1 rounded text-xs whitespace-nowrap ${getSeverityColor(cve.severity)}`}>
                                    {cve.severity}
                                  </span>
                                </div>
                                <p className="text-sm text-gray-900 mb-2">{cve.summary || 'No details available'}</p>
                                <div className={`mt-2 p-2 rounded border-l-4 ${
                                  cve.confidence === 'high' ? 'bg-red-50 border-red-400' :
                                  cve.confidence === 'medium' ? 'bg-orange-50 border-orange-400' :
                                  'bg-yellow-50 border-yellow-400'
                                }`}>
                                  <p className={`text-xs ${
                                    cve.confidence === 'high' ? 'text-red-800' :
                                    cve.confidence === 'medium' ? 'text-orange-800' :
                                    'text-yellow-800'
                                  }`}>
                                    <strong>Confidence:</strong> {cve.confidence_reason || 'Based on technology detection without version confirmation'}
                                  </p>
                                </div>
                              </li>
                            );
                          })}
                        </ul>
                      </div>
                    );
                  }

                  // CASE 3: Version not detected - show skip message with button
                  if (cveStatus === 'skipped') {
                    return (
                      <div>
                        <div className="bg-gray-100 text-gray-800 rounded p-4 mb-4">
                          <p className="font-semibold mb-1">CVE Scan Skipped</p>
                          <p className="text-sm mb-2">Detected software: <strong>{detectedSoftware || 'Unknown'}</strong></p>
                          <p className="text-sm mb-3">Version: <strong>{scanData.site?.software_version ? scanData.site.software_version : 'Not exposed'}</strong></p>
                          <p className="text-sm">{cveStatus.reason || 'A CVE is version-specific. CVE matching requires version information'}</p>
                        </div>
                        <button
                          onClick={() => handleRunCveIntel(detectedSoftware)}
                          disabled={cveIntelLoading}
                          className={`px-4 py-2 rounded font-semibold transition ${
                            cveIntelLoading
                              ? 'bg-gray-400 text-gray-700 cursor-not-allowed'
                              : 'bg-indigo-600 text-white hover:bg-indigo-700'
                          }`}
                        >
                          {cveIntelLoading ? 'Scanning CVEs...' : 'Run CVE Threat Intelligence Scan'}
                        </button>
                        <p className="text-xs text-gray-600 mt-2">
                        
                        </p>
                      </div>
                    );
                  }
                  
                  // CASE 4: Loading intel
                  if (cveIntelLoading) {
                    return (
                      <div className="py-8">
                        {/* Animated Background */}
                        <div className="relative w-full h-48 mb-6 rounded-lg overflow-hidden bg-gradient-to-b from-blue-900/30 to-transparent border border-blue-500/30">
                          {/* Animated Grid Background */}
                          <div className="absolute inset-0 opacity-20">
                            <div className="absolute inset-0" style={{
                              backgroundImage: 'linear-gradient(90deg, #3b82f6 1px, transparent 1px), linear-gradient(#3b82f6 1px, transparent 1px)',
                              backgroundSize: '20px 20px',
                              animation: 'slide 20s linear infinite'
                            }} />
                          </div>

                          {/* Scanning Pulse Circles */}
                          <div className="absolute inset-0 flex items-center justify-center">
                            <div className="relative w-32 h-32">
                              {/* Outer circle */}
                              <div className="absolute inset-0 rounded-full border-2 border-blue-400/40 animate-pulse" />
                              {/* Middle circle */}
                              <div className="absolute inset-4 rounded-full border-2 border-cyan-400/60" style={{animation: 'spin 3s linear infinite'}} />
                              {/* Inner circle with glow */}
                              <div className="absolute inset-8 rounded-full bg-gradient-to-r from-blue-500 to-cyan-500 blur-lg opacity-40" style={{animation: 'pulse 2s cubic-bezier(.4,0,.6,1) infinite'}} />
                              {/* Center icon */}
                              <div className="absolute inset-0 flex items-center justify-center">
                                <svg className="w-12 h-12 text-cyan-300 animate-bounce" fill="currentColor" viewBox="0 0 20 20">
                                  <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" />
                                </svg>
                              </div>
                            </div>
                          </div>

                          {/* Animated vertical lines (scanning) */}
                          <div className="absolute inset-0 flex items-center justify-around opacity-40">
                            {[...Array(5)].map((_, i) => (
                              <div
                                key={i}
                                className="w-0.5 bg-cyan-400 rounded-full"
                                style={{
                                  height: '60%',
                                  animation: `scan 1.5s ease-in-out infinite`,
                                  animationDelay: `${i * 0.15}s`
                                }}
                              />
                            ))}
                          </div>
                        </div>

                        {/* Text Status */}
                        <div className="text-center space-y-3">
                          <h3 className="text-xl font-bold text-cyan-300 flex items-center justify-center gap-2">
                            <span className="inline-block w-2 h-2 rounded-full bg-cyan-400 animate-pulse" />
                            Searching CVEs related to the server
                            <span className="inline-block w-2 h-2 rounded-full bg-cyan-400 animate-pulse" style={{animationDelay: '0.3s'}} />
                          </h3>
                          <p className="text-sm text-gray-300">Analyzing detected technologies and cross-referencing with vulnerability databases...</p>
                          
                          {/* Progress dots */}
                          <div className="flex items-center justify-center gap-1 mt-4">
                            {[...Array(3)].map((_, i) => (
                              <div
                                key={i}
                                className="w-2 h-2 rounded-full bg-cyan-400"
                                style={{
                                  animation: 'bounce 1.4s infinite ease-in-out',
                                  animationDelay: `${i * 0.16}s`
                                }}
                              />
                            ))}
                          </div>
                        </div>

                        {/* Styles */}
                        <style>{`
                          @keyframes spin {
                            from { transform: rotate(0deg); }
                            to { transform: rotate(360deg); }
                          }
                          @keyframes pulse {
                            0%, 100% { opacity: 0.4; }
                            50% { opacity: 0.8; }
                          }
                          @keyframes slide {
                            0% { transform: translateX(0); }
                            100% { transform: translateX(20px); }
                          }
                          @keyframes scan {
                            0%, 100% { height: 0; opacity: 0; }
                            50% { height: 60%; opacity: 1; }
                          }
                          @keyframes bounce {
                            0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
                            40% { opacity: 1; transform: scale(1); }
                          }
                        `}</style>
                      </div>
                    );
                  }
                  
                  // CASE 5: No CVEs found
                  return (
                    <div className="bg-gray-100 text-gray-800 rounded p-3 text-sm">
                      <p className="font-semibold">No CVEs Detected</p>
                      <p>No known vulnerabilities found for the detected software.</p>
                    </div>
                  );
                })()}
              </div>

              {/* Other Risks */}
              <div className="bg-gradient-to-r from-pink-400 via-pink-300 to-pink-500 shadow-xl rounded-lg p-6 animate-fadein text-white result-glow">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-xl font-bold text-indigo-700">Other Observations</h2>
                  <a href="https://otx.alienvault.com/" target="_blank" rel="noopener noreferrer" className="text-lg text-indigo-600 underline font-bold" style={{alignSelf:'center', marginLeft:'auto', marginRight:'auto'}}>Learn more about threat intelligence (OTX)</a>
                </div>
                {scanData.findings?.filter((f) => f.category !== "cve" && f.category !== "network" && !(f.detail && f.detail.toLowerCase().includes("server header reveals server software"))).length > 0 ? (
                  <ul className="space-y-3">
                    {scanData.findings
                      .filter((f) => f.category !== "cve" && f.category !== "network" && !(f.detail && f.detail.toLowerCase().includes("server header reveals server software")))
                      .map((risk, idx) => {
                        if (risk.category === "threat-intel" && risk.evidence?.pulses?.length > 0) {
                          return (
                            <li key={idx} className="border rounded p-3">
                              <div className="font-semibold mb-1">Domain flagged in {risk.evidence.pulses.length} security reports</div>
                              <div className="text-gray-700 mb-2">This website‚Äôs domain has been linked to malware, ransomware, and botnet attacks in multiple security databases.</div>
                              <div className="mb-2 text-gray-700">
                                Some recent reports:
                                <ul className="list-disc pl-6 mt-1">
                                  {risk.evidence.pulses.map((p, i) => (
                                    <li key={i}>
                                      <a href={p.url || `https://otx.alienvault.com/pulse/${p.id}`} target="_blank" rel="noopener noreferrer" className="text-indigo-600 underline">
                                        {p.name}
                                      </a>
                                      {p.author ? ` ‚Äî ${p.author}` : ""}
                                      {p.modified ? ` (${p.modified.split("T")[0]})` : ""}
                                    </li>
                                  ))}
                                </ul>
                              </div>
                              <div className="text-sm text-gray-700 mb-2" style={{color:'#222',fontWeight:500,opacity:0.85}}>
                                <strong>Recommendation:</strong> Check the above links for the risks mentioned.
                              </div>
                            </li>
                          );
                        }
                        if (risk.category !== "threat-intel") {
                          return (
                            <li key={idx} className="border rounded p-3">
                              <div className="font-semibold mb-1">Other Risk</div>
                              <div className="text-gray-700 mb-2">{risk.detail || risk.title}</div>
                              <div className="text-sm text-gray-700 mb-2" style={{color:'#222',fontWeight:500,opacity:0.85}}>
                                <strong>Recommendation:</strong> Review this finding for more details.
                              </div>
                            </li>
                          );
                        }
                        return null;
                      })}
                  </ul>
                ) : (
                  <p>No other risks found.</p>
                )}
              </div>

              {/* Network Exposure Summary */}
              {scanData.network_exposure && (
                <div className="bg-gradient-to-r from-green-500 via-green-400 to-green-600 shadow-xl rounded-lg p-6 animate-fadein text-white result-glow border-2 border-green-400 w-full">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-2xl font-bold text-indigo-700">Network Exposure Summary</h2>
                  </div>
                  {scanData.scan_status === 'limited' ? (
                    <div className="bg-yellow-100 text-yellow-800 rounded p-3 text-sm">
                      <p> Network scan limited due to connection restrictions enforced by the target.</p>
                    </div>
                  ) : (
                    <div>
                      <div className="mb-4 p-3 rounded bg-white/20">
                        <p className="text-lg font-bold text-white">Exposed Network Services: {scanData.network_exposure.total_exposed || 0}</p>
                        <p className="text-sm text-gray-100 mt-1">Filtered or Closed Ports: {scanData.network_exposure.total_closed_filtered || 0}</p>
                      </div>

                      {/* High Risk Administrative Services */}
                      {scanData.network_exposure.admin_services && scanData.network_exposure.admin_services.length > 0 && (
                        <div className="mb-4">
                          <h3 className="text-lg font-bold text-red-700 mb-2">‚ö†Ô∏è High Risk Administrative Services</h3>
                          <div className="space-y-2">
                            {scanData.network_exposure.admin_services.map((port) => {
                              const portNames = { 21: 'FTP (File Transfer Protocol)', 22: 'SSH (Secure Shell)' };
                              return (
                                <div key={port} className="bg-white/10 rounded p-3">
                                  <p className="text-white font-semibold">{portNames[port] || `Port ${port}`}</p>
                                  <p className="text-sm text-gray-100">This administrative service is exposed to the network.</p>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      )}

                      {/* Mail Services Exposed */}
                      {scanData.network_exposure.mail_services && scanData.network_exposure.mail_services.length > 0 && (
                        <div className="mb-4">
                          <h3 className="text-lg font-bold text-amber-600 mb-2">üìß Mail Services Exposed</h3>
                          <div className="space-y-2">
                            {scanData.network_exposure.mail_services.map((port) => {
                              const portNames = { 110: 'POP3 (Port 110)', 143: 'IMAP (Port 143)', 465: 'SMTP Secure (Port 465)', 587: 'SMTP Submission (Port 587)' };
                              return (
                                <div key={port} className="bg-white/10 rounded p-3">
                                  <p className="text-white font-semibold">{portNames[port] || `Port ${port}`}</p>
                                  <p className="text-sm text-gray-100">Mail service is reachable on this port.</p>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      )}

                      {/* Web Services */}
                      {scanData.network_exposure.web_services && scanData.network_exposure.web_services.length > 0 && (
                        <div className="mb-4">
                          <h3 className="text-lg font-bold text-gray-700 mb-2">üåê Web Services</h3>
                          <div className="space-y-2">
                            {scanData.network_exposure.web_services.map((port) => {
                              const portNames = { 80: 'HTTP (Port 80)', 443: 'HTTPS (Port 443)' };
                              return (
                                <div key={port} className="bg-white/10 rounded p-3">
                                  <p className="text-white font-semibold">{portNames[port] || `Port ${port}`}</p>
                                  <p className="text-sm text-gray-100">Web service is reachable on this port. (Expected for web servers)</p>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      )}

                      {/* Other Services */}
                      {scanData.network_exposure.other_services && scanData.network_exposure.other_services.length > 0 && (
                        <div className="mb-4">
                          <h3 className="text-lg font-bold text-gray-400 mb-2">Other Exposed Services</h3>
                          <div className="space-y-2">
                            {scanData.network_exposure.other_services.map((port) => (
                              <div key={port} className="bg-white/10 rounded p-3">
                                <p className="text-white font-semibold">Port {port}</p>
                                <p className="text-sm text-gray-100">Service detected on this port.</p>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Collapsible Explanation */}
                      <details className="mt-4 cursor-pointer">
                        <summary className="font-semibold text-white text-base hover:underline">Why do open ports matter?</summary>
                        <div className="mt-2 text-sm text-gray-100 p-3 bg-white/10 rounded">
                          <p>Ports are communication endpoints for services running on a server. Some ports are expected (like 80 for HTTP), while others increase attack surface (like 22 for SSH). Administrative services should be restricted to private networks.</p>
                        </div>
                      </details>
                    </div>
                  )}
                  <style>{`
                    @keyframes pulse { 0%{box-shadow:0 0 0 0 #22c55e;} 70%{box-shadow:0 0 16px 4px #22c55e;} 100%{box-shadow:0 0 0 0 #22c55e;} }
                    .animate-pulse { animation: pulse 1.5s infinite; }
                    
                    @keyframes confidence-glow {
                      0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
                      50% { box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1); }
                    }
                    .confidence-badge {
                      animation: confidence-glow 2s ease-in-out infinite;
                    }
                    
                    @keyframes threat-pulse {
                      0%, 100% { opacity: 0.8; }
                      50% { opacity: 1; }
                    }
                    .threat-indicator {
                      animation: threat-pulse 3s ease-in-out infinite;
                    }
                    
                    .cve-card {
                      position: relative;
                      overflow: hidden;
                    }
                    .cve-card::before {
                      content: '';
                      position: absolute;
                      top: 0;
                      left: -100%;
                      width: 100%;
                      height: 100%;
                      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
                      transition: left 0.5s;
                    }
                    .cve-card:hover::before {
                      left: 100%;
                    }
                    
                    .confirmed-cve {
                      border-left: 4px solid #22c55e;
                      background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(34, 197, 94, 0.02) 100%);
                    }
                    
                    .intel-cve {
                      border-left: 4px solid #f59e0b;
                      background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, rgba(245, 158, 11, 0.02) 100%);
                    }
                  `}</style>
                </div>
              )}

              {/* PDF Download */}
              <div className="mt-6">
                <button
                  onClick={downloadPDF}
                  className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                >
                  Send Report to your Devs
                </button>
              </div>
                </div>
              </>
            )}
          </div>
        )}
      </div>
    </div>
  );
}
